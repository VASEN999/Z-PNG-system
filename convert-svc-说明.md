# 微服务架构说明文档

本系统采用微服务架构，将文件处理功能拆分为多个独立服务，提高系统的可维护性和可扩展性。

## 系统架构

整个系统包含以下三个主要服务：

1. **主应用服务** - 基于Flask的Web应用，提供用户界面和主要业务逻辑
2. **文件转换服务(convert-svc)** - 基于Go的高性能文件转换服务
3. **文件归档服务(archive-svc)** - 基于FastAPI的异步文件归档与检索服务

### 架构图

```
+----------------+      +---------------+      +---------------+
|                |      |               |      |               |
|  主应用服务     +----->+ 文件转换服务   |      |  文件归档服务  |
|  (Flask)       |      | (Go)         |      | (FastAPI)     |
|                +----->+               |      |               |
+----------------+      +---------------+      +---------------+
        |                                              ^
        |                                              |
        +----------------------------------------------+
```

## 服务交互

1. 主应用接收用户上传的文件，同时调用归档服务保存文件并计算哈希
2. 当需要转换文件时，主应用优先调用Go转换服务，如果不可用则回退到本地实现
3. 主应用可以通过哈希值查询归档服务，检索和下载历史文件

## 技术选择

1. **主应用**：Python + Flask
   - 成熟稳定，开发效率高
   - 丰富的生态系统

2. **文件转换服务**：Go
   - 高性能，适合CPU密集型操作
   - 并发处理能力强
   - 静态编译，部署简单

3. **文件归档服务**：Python + FastAPI
   - 异步I/O，适合I/O密集型操作
   - 自动生成OpenAPI文档
   - 类型提示和验证

## 通信方式

服务间通过HTTP API进行通信，主要端点：

1. **文件转换服务**
   - `GET /api/health` - 健康检查
   - `POST /api/convert` - 转换单个文件
   - `POST /api/convert-batch` - 批量转换文件

2. **文件归档服务**
   - `GET /api/v1/health` - 健康检查
   - `POST /api/v1/archive/files` - 上传并归档文件
   - `GET /api/v1/archive/files/{file_id}` - 获取文件详情
   - `GET /api/v1/archive/files/hash/{hash_value}` - 根据哈希获取文件

## 启动服务

可以使用集成启动脚本启动所有服务：

```bash
./start-all-services.sh
```

或者分别启动各个服务：

```bash
# 启动主应用
cd 2025-05-14-16.25
python src/run.py

# 启动转换服务
cd convert-svc
./start-convert-svc.sh

# 启动归档服务
cd archive-svc
./start-archive-svc.sh
```

## 配置

主应用通过环境变量配置微服务的URL：

```
CONVERT_SVC_URL=http://localhost:8080/api
ARCHIVE_SVC_URL=http://localhost:8000/api/v1/archive
```

## 容错机制

1. 主应用会检查微服务的可用性，如果不可用则降级到本地实现
2. 服务间通信设置了超时机制，避免长时间等待
3. 归档服务保证数据的持久化和可恢复性 