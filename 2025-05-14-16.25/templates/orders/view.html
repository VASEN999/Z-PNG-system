{% extends "base.html" %}

{% block title %}订单 #{{ order.order_number }} - 文件转换工具{% endblock %}

{% block styles %}
<style>
    /* 状态按钮样式优化 */
    .status-btn {
        min-width: 60px;
        padding: 0.25rem 0.5rem;
        margin-right: 2px;
    }
    
    /* 移动端响应式调整 */
    @media (max-width: 576px) {
        .status-btn {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }
    }
    
    /* Tab导航样式优化 */
    #mainContentTabs {
        border-bottom: none;
    }
    
    #mainContentTabs .nav-item {
        margin-bottom: 0;
    }
    
    #mainContentTabs .nav-link {
        border: 1px solid transparent;
        border-top-left-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
        color: #495057;
        background-color: #f8f9fa;
        border-color: #dee2e6 #dee2e6 #fff;
        position: relative;
        top: 1px;
    }
    
    #mainContentTabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6;
    }
    
    #mainContentTabs .nav-link.active {
        color: #495057;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
    }
    
    .tab-content {
        padding-top: 0.5rem;
    }
    
    /* 材料分类区域样式 */
    .material-category-container {
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 8px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
    }
    
    .category-content {
        padding: 5px;
        min-height: 30px;
        background-color: #fff;
    }
    
    /* 文件项样式 */
    .file-item {
        background-color: white;
        padding: 2px 4px;
        margin: 2px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        position: relative;
        font-size: 0.85rem;
    }
    
    .assigned-file {
        background-color: #e6f7ff;
        border-color: #91d5ff;
    }
    
    /* 删除按钮样式 */
    .remove-item {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 18px;
        height: 18px;
        background-color: #ff4d4f;
        color: white;
        border-radius: 50%;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        cursor: pointer;
        display: none;
        z-index: 20;
    }
    
    .draggable-item:hover .remove-item {
        display: flex;
    }
    
    /* 拖拽时的占位符样式 */
    .drag-placeholder {
        width: 60px;
        height: 60px;
        border: 1px dashed #999;
        background-color: #f0f0f0;
        margin: 2px;
    }
    
    /* 拖拽目标高亮 */
    .category-content.drag-over {
        background-color: rgba(0, 123, 255, 0.1);
        border: 1px dashed #007bff;
    }
    
    /* 分类统计徽章 */
    .category-count {
        font-size: 0.75rem;
        background-color: #6c757d;
    }
    
    /* PNG池中的卡片拖拽样式 */
    .col-md-3.col-sm-4.col-6.mb-3 .card, .png-file-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: move;
    }
    
    .col-md-3.col-sm-4.col-6.mb-3 .card:hover, .png-file-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .col-md-3.col-sm-4.col-6.mb-3 .card.dragging, .png-file-card.dragging {
        opacity: 0.5;
        transform: scale(1.05);
    }
    
    /* 左侧分类区域可滚动（当高度超过视口高度时） */
    .category-sidebar .sticky-top {
        max-height: calc(100vh - 30px);
        overflow-y: auto;
    }
    
    /* 分类区域整体布局优化 */
    .category-sidebar .card-body {
        padding-top: 0.5rem !important; 
        padding-bottom: 0.5rem !important;
    }
    
    /* 按钮组优化 */
    .category-sidebar .btn {
        padding: 0.2rem 0.5rem;
        font-size: 0.8rem;
    }

    /* 确保材料分类标题不换行 */
    .card-header h5 {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* 定义一个统一的内容区高度 */
    :root {
        --content-height: calc(80vh - 150px);
        --min-content-height: 600px;
    }
    
    /* 统一左侧分类区域和右侧Tab内容区域高度 */
    #categoriesContainer {
        height: var(--content-height);
        min-height: var(--min-content-height);
        overflow-y: auto;
    }
    
    .tab-pane {
        height: var(--content-height);
        min-height: var(--min-content-height);
        overflow-y: auto;
    }
    
    /* 响应式调整 */
    @media (max-width: 992px) {
        /* 中小屏设备回退到原布局 */
        .category-sidebar {
            width: 100%;
            margin-bottom: 1rem;
        }
        
        /* 移除sticky定位 */
        .category-sidebar .sticky-top {
            position: relative !important;
            top: 0 !important;
        }
    }
</style>
{% endblock %}

{% block content %}
{% set filter_params = filter_params|default({}) %}

<!-- 页面标题和操作按钮 -->
<div class="container-fluid mt-3">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    {% if order.status == order.STATUS_PENDING %}
                    <span class="badge bg-warning me-1">待处理</span>
                    {% elif order.status == order.STATUS_MATERIAL %}
                    <span class="badge bg-danger me-1">补材料</span>
                    {% elif order.status == order.STATUS_REVIEWED %}
                    <span class="badge bg-success me-1">已审核</span>
                    {% endif %}
                    订单详情 #{{ order.order_number }}
                </h4>
                <div>
                    <a href="{{ url_for('orders.index', **filter_params) }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> 返回订单列表
                    </a>
                    <!-- 只有管理员可见的转交按钮 -->
                    {% if current_user.is_admin %}
                    <button type="button" class="btn btn-sm btn-warning ms-1" id="transferOrderBtn">
                        <i class="bi bi-arrow-right-circle"></i> 转交订单
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- 左侧分类区 -->
        <div class="col-lg-3 col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-2">材料分类</h5>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-sm btn-primary flex-grow-1 me-1" id="saveClassification">
                            <i class="bi bi-save"></i> 保存分类
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary flex-grow-1" id="resetClassification">
                            <i class="bi bi-arrow-counterclockwise"></i> 重置
                        </button>
                    </div>
                </div>
                <div class="card-body p-2" id="categoriesContainer">
                    <!-- 文件分类区 -->
                    {% for category in categories %}
                    <div class="card category-container mb-2">
                        <div class="card-header py-2 ps-2 pe-1 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate" title="{{ category.name }}">{{ category.name }}</h6>
                        </div>
                        <div class="card-body p-1 category-droppable" data-category-id="{{ category.id }}" style="min-height: 50px;">
                            {% for assignment in category.assignments %}
                                {% for file in order.files %}
                                    {% if file.filename == assignment.filename %}
                                    <div class="draggable-item file-item mb-1 p-1 border rounded assigned-file" 
                                         data-file-uuid="{{ file.filename }}"
                                         data-category-id="{{ category.id }}">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1 text-truncate" title="{{ file.original_filename }}">
                                                <small>{{ file.original_filename }}</small>
                                            </div>
                                            <div class="ms-1">
                                                <a href="javascript:void(0);" class="preview-link btn btn-sm btn-outline-primary py-0 px-1" 
                                                   data-toggle="modal" data-target="#imagePreviewModal" 
                                                   data-image-url="{{ url_for('main.preview_file', filename=file.filename, order_id=order.id) }}" 
                                                   data-image-name="{{ file.original_filename }}"
                                                   data-file-uuid="{{ file.filename }}">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- 如果没有分类数据，添加默认分类 -->
                    {% if not categories or categories|length == 0 %}
                    <div class="card category-container mb-2">
                        <div class="card-header py-2 ps-2 pe-1 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate" title="申请表&同意书">申请表&同意书</h6>
                        </div>
                        <div class="card-body p-1 category-droppable" data-category-id="1" style="min-height: 50px;">
                        </div>
                    </div>
                    
                    <div class="card category-container mb-2">
                        <div class="card-header py-2 ps-2 pe-1 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate" title="护照首页&证件照">护照首页&证件照</h6>
                        </div>
                        <div class="card-body p-1 category-droppable" data-category-id="2" style="min-height: 50px;">
                        </div>
                    </div>
                    
                    <div class="card category-container mb-2">
                        <div class="card-header py-2 ps-2 pe-1 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate" title="户口本&身份证">户口本&身份证</h6>
                        </div>
                        <div class="card-body p-1 category-droppable" data-category-id="3" style="min-height: 50px;">
                        </div>
                    </div>
                    
                    <div class="card category-container mb-2">
                        <div class="card-header py-2 ps-2 pe-1 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate" title="经济&学历材料">经济&学历材料</h6>
                        </div>
                        <div class="card-body p-1 category-droppable" data-category-id="4" style="min-height: 50px;">
                        </div>
                    </div>
                    
                    <div class="card category-container mb-2">
                        <div class="card-header py-2 ps-2 pe-1 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate" title="关系证明">关系证明</h6>
                        </div>
                        <div class="card-body p-1 category-droppable" data-category-id="5" style="min-height: 50px;">
                        </div>
                    </div>
                    
                    <div class="card category-container mb-2">
                        <div class="card-header py-2 ps-2 pe-1 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate" title="其他材料">其他材料</h6>
                        </div>
                        <div class="card-body p-1 category-droppable" data-category-id="6" style="min-height: 50px;">
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 中间内容区 -->
        <div class="col-lg-9 col-md-8">
            <div class="card mb-3">
                <div class="card-header p-0 border-bottom-0">
                    <ul class="nav nav-tabs" id="mainContentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="png-pool-tab" data-bs-toggle="tab" data-bs-target="#png-pool-content" 
                                    type="button" role="tab" aria-controls="png-pool-content" aria-selected="true">
                                <i class="bi bi-grid-3x3"></i> PNG文件池 ({{ converted_files|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-content" 
                                    type="button" role="tab" aria-controls="upload-content" aria-selected="false">
                                <i class="bi bi-upload"></i> 文件上传
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="db-files-tab" data-bs-toggle="tab" data-bs-target="#db-files-content" 
                                    type="button" role="tab" aria-controls="db-files-content" aria-selected="false">
                                <i class="bi bi-database"></i> 文件记录 ({{ order.files|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content" 
                                    type="button" role="tab" aria-controls="info-content" aria-selected="false">
                                <i class="bi bi-info-circle"></i> 基本信息
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="mainContentTabContent">
                        <!-- PNG池Tab内容 -->
                        <div class="tab-pane fade show active" id="png-pool-content" role="tabpanel" aria-labelledby="png-pool-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">PNG文件池 ({{ converted_files|length }})</h5>
                                {% if converted_files %}
                                <div>
                                    <a href="{{ url_for('main.download_all', order_id=order.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-download"></i> 下载全部
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if converted_files %}
                            <div class="row">
                                {% for file in converted_files %}
                                <div class="col-md-4 col-sm-4 col-6 mb-3">
                                    <div class="card h-100 png-file-card" data-file-uuid="{% if file.id %}{{ file.id }}{% else %}{{ file }}{% endif %}">
                                        <div class="card-body p-2 text-center">
                                            <a href="javascript:void(0);" class="preview-link" data-toggle="modal" data-target="#imagePreviewModal" 
                                               data-image-url="{{ url_for('main.preview_file', filename=file.id|default(file), order_id=order.id) }}" 
                                               data-image-name="{{ file.filename|default(file) }}"
                                               data-file-uuid="{% if file.id %}{{ file.id }}{% else %}{{ file }}{% endif %}">
                                                <img src="{{ url_for('main.preview_file', filename=file.id|default(file), order_id=order.id) }}" 
                                                     alt="{{ file.filename|default(file) }}" class="img-fluid mb-2" 
                                                     style="max-height: 120px; border-radius: 5px;" 
                                                     onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'text-center py-3 text-warning\'><i class=\'bi bi-exclamation-triangle\' style=\'font-size: 3rem;\'></i><p class=\'small mt-2\'>文件可能已被移动或删除</p></div>';">
                                            </a>
                                            <p class="small text-truncate mb-0" title="{{ file.filename|default(file) }}">{{ file.filename|default(file) }}</p>
                                        </div>
                                        <div class="card-footer p-1">
                                            <a href="{{ url_for('main.download_file_by_name', filename=file.id|default(file), order_id=order.id) }}" class="btn btn-sm btn-outline-primary w-100">
                                                <i class="bi bi-download"></i> 下载
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <p class="mb-0">还没有PNG文件。上传文件并点击处理按钮开始转换。</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- 文件上传Tab内容 -->
                        <div class="tab-pane fade" id="upload-content" role="tabpanel" aria-labelledby="upload-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">文件上传区域</h5>
                                {% if order.files %}
                                <div>
                                    <form action="{{ url_for('main.process') }}" method="post" id="process-form" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="order_id" value="{{ order.id }}">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="bi bi-gear"></i> 处理所有文件
                                        </button>
                                    </form>
                                    <form action="{{ url_for('main.clear_png_cache') }}" method="post" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="order_id" value="{{ order.id }}">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定要清空PNG池吗？这将删除所有转换后的PNG文件，但保留原始上传文件。您可以点击\'处理所有文件\'重新生成PNG文件。');">
                                            <i class="bi bi-trash"></i> 清空PNG池
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            
                            <form action="{{ url_for('main.upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="order_id" value="{{ order.id }}">
                                <div class="dropzone" id="dropzone" style="border: 2px dashed #ccc; border-radius: 5px; padding: 25px; text-align: center; cursor: pointer;">
                                    <i class="bi bi-cloud-upload fs-1"></i>
                                    <p>拖放文件至此处上传，或点击选择文件</p>
                                    <p class="text-muted small">支持PDF、Word、PPT、图片和ZIP压缩包等多种格式</p>
                                    <input type="file" name="files[]" id="file-input" multiple style="display: none;">
                                </div>
                                <div class="d-grid mt-3">
                                    <button type="button" id="upload-button" class="btn btn-primary">
                                        <i class="bi bi-upload"></i> 上传文件
                                    </button>
                                </div>
                            </form>
                            
                            <!-- 上传状态指示器 -->
                            <div id="upload-status" class="alert alert-info mt-3" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">正在上传...</span>
                                    </div>
                                    <div>文件上传中，请稍候...</div>
                                </div>
                            </div>
                            
                            <!-- 处理状态指示器 -->
                            <div id="process-status" class="alert alert-info mt-3" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">正在处理...</span>
                                    </div>
                                    <div>文件处理中，请稍候...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 数据库文件记录Tab内容 -->
                        <div class="tab-pane fade" id="db-files-content" role="tabpanel" aria-labelledby="db-files-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">数据库文件记录 ({{ order.files|length }})</h5>
                            </div>
                            
                            {% if order.files %}
                            <div class="list-group">
                                {% for file in order.files %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ file.original_filename }}</h6>
                                        <div>
                                            <small class="me-2">{{ file.upload_time.strftime('%m-%d %H:%M') }}</small>
                                            <a href="{{ url_for('main.delete_upload', filename=file.filename) }}" 
                                               class="btn btn-sm btn-outline-danger" 
                                               title="删除文件" 
                                               onclick="return confirm('确定要删除此文件吗？');">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <p class="mb-1 small text-muted">
                                        类型: {{ file.file_type or '未知' }} | 
                                        大小: {{ file.file_size|filesizeformat if file.file_size else 'N/A' }}
                                    </p>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="alert alert-info mb-0">
                                <p class="mb-0">没有上传文件记录</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- 基本信息Tab内容 -->
                        <div class="tab-pane fade" id="info-content" role="tabpanel" aria-labelledby="info-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">基本信息</h5>
                            </div>
                            
                            <table class="table table-bordered">
                                <tr>
                                    <th style="width: 30%">订单号</th>
                                    <td>{{ order.order_number }}</td>
                                </tr>
                                <tr>
                                    <th>创建时间</th>
                                    <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>
                                <tr>
                                    <th>更新时间</th>
                                    <td>{{ order.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>
                                <tr>
                                    <th>创建者</th>
                                    <td>
                                        {% if order.user %}
                                        {{ order.user.username }}
                                        {% if order.user.is_admin %}<span class="badge bg-danger">管理员</span>{% endif %}
                                        {% else %}
                                        <span class="text-muted">未知</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <!-- 添加合并信息行 -->
                                {% if order.is_merged %}
                                <tr>
                                    <th>合并信息</th>
                                    <td>
                                        <span class="badge bg-info">合并订单</span>
                                        <div class="mt-2">
                                            <small class="text-muted">合并自以下订单：</small>
                                            <ul class="list-unstyled ms-2 mt-1">
                                                {% if order.merged_from %}
                                                    {% for source_number in order.merged_from.split(',') %}
                                                        <li>
                                                            <small>
                                                                <a href="{{ url_for('orders.view_order', order_number=source_number) }}" class="text-decoration-none">
                                                                    <i class="bi bi-box"></i> {{ source_number }}
                                                                </a>
                                                            </small>
                                                        </li>
                                                    {% endfor %}
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>状态</th>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <div class="mb-2">
                                                {% if order.status == order.STATUS_PENDING %}
                                                <span class="badge bg-warning">{{ order.status_display }}</span>
                                                {% elif order.status == order.STATUS_MATERIAL %}
                                                <span class="badge bg-danger">{{ order.status_display }}</span>
                                                {% elif order.status == order.STATUS_REVIEWED %}
                                                <span class="badge bg-success">{{ order.status_display }}</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ order.status_display }}</span>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- 状态变更按钮组 -->
                                            <div>
                                                <form action="{{ url_for('orders.update_order_status', order_number=order.order_number) }}" method="post" class="status-form w-100">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    {% for key, value in filter_params.items() %}
                                                    <input type="hidden" name="_{{ key }}" value="{{ value }}">
                                                    {% endfor %}
                                                    <div class="d-flex flex-wrap gap-1">
                                                        <button type="button" data-status="{{ order.STATUS_PENDING }}" class="btn btn-sm btn-outline-warning status-btn flex-grow-1 {% if order.status == order.STATUS_PENDING %}active{% endif %}">
                                                            待处理
                                                        </button>
                                                        <button type="button" data-status="{{ order.STATUS_MATERIAL }}" class="btn btn-sm btn-outline-danger status-btn flex-grow-1 {% if order.status == order.STATUS_MATERIAL %}active{% endif %}">
                                                            补材料
                                                        </button>
                                                        <button type="button" data-status="{{ order.STATUS_REVIEWED }}" class="btn btn-sm btn-outline-success status-btn flex-grow-1 {% if order.status == order.STATUS_REVIEWED %}active{% endif %}">
                                                            已审核
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr id="editNote">
                                    <th>备注</th>
                                    <td>
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div id="noteDisplay" class="text-wrap text-break" style="max-width: 100%; max-height: 100px; overflow: auto;" title="{{ order.note }}">{{ order.note or '-' }}</div>
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="editNoteBtn">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </div>
                                        
                                        <div id="noteEditForm" style="display: none;" class="mt-2">
                                            <form action="{{ url_for('orders.update_note', order_number=order.order_number) }}" method="post" id="noteForm">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                {% for key, value in filter_params.items() %}
                                                <input type="hidden" name="_{{ key }}" value="{{ value }}">
                                                {% endfor %}
                                                <div class="form-group">
                                                    <textarea name="note" class="form-control form-control-sm" rows="3">{{ order.note or '' }}</textarea>
                                                </div>
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-sm btn-primary" id="saveNoteBtn">保存</button>
                                                    <button type="button" class="btn btn-sm btn-secondary ms-1" id="cancelEditBtn">取消</button>
                                                </div>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>上传文件</th>
                                    <td>{{ order.files|length }} 个</td>
                                </tr>
                                <tr>
                                    <th>转换文件</th>
                                    <td>{{ order.conversions|length }} 个</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图片预览模态框 -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">图片预览</h5>
                <div class="btn-group mx-2">
                    <button type="button" id="prevImageButton" class="btn btn-sm btn-outline-secondary" title="上一张图片">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <button type="button" id="nextImageButton" class="btn btn-sm btn-outline-secondary" title="下一张图片">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <button type="button" id="zoomInButton" class="btn btn-sm btn-outline-secondary" title="放大">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button type="button" id="zoomOutButton" class="btn btn-sm btn-outline-secondary" title="缩小">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button type="button" id="resetZoomButton" class="btn btn-sm btn-outline-secondary" title="重置缩放">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>
                <div class="modal-page-info ms-2 me-auto">
                    <span id="currentImageIndex">1</span>/<span id="totalImages">1</span>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div id="imageContainer" class="text-center" style="overflow: hidden; position: relative; height: 70vh; background-color: #f8f9fa;">
                    <img id="previewImage" src="" alt="预览图片" style="max-height: 100%; max-width: 100%; transition: transform 0.2s; cursor: grab;">
                </div>
            </div>
            <div class="modal-footer">
                <div class="text-muted small me-auto">
                    <i class="bi bi-info-circle"></i> 提示：滚轮可缩放，左键拖动可移动图片，左右箭头键或按钮可切换图片
                </div>
                <a id="downloadLink" href="#" class="btn btn-primary" download>
                    <i class="bi bi-download"></i> 下载图片
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 转交订单模态窗口，直接放在content块内 -->
{% if current_user.is_admin %}
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferModalLabel">转交订单</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <input type="hidden" id="orderNumber" value="{{ order.order_number }}">
                    {% for key, value in filter_params.items() %}
                    <input type="hidden" name="_{{ key }}" value="{{ value }}">
                    {% endfor %}
                    <div class="mb-3">
                        <label for="targetUserId" class="form-label">选择目标用户</label>
                        <select class="form-select" id="targetUserId" name="target_user_id" required>
                            <option value="">请选择...</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}" {% if user.id == order.user_id %}disabled{% endif %}>
                                {{ user.username }} ({{ "管理员" if user.is_admin else "普通用户" }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transferNote" class="form-label">转交备注（可选）</label>
                        <textarea class="form-control" id="transferNote" name="note" rows="3" placeholder="可以添加转交原因或其他说明"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmTransfer">确认转交</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block modals %}
{{ super() }}
<!-- 移除这里的转交订单模态窗口，已移到content块 -->
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 设置AJAX请求默认包含CSRF令牌
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", $('meta[name="csrf-token"]').attr('content'));
                }
            }
        });
    
        // 初始化所有模态窗口
        $(document).ready(function() {
            // 使用正确的Bootstrap 4语法初始化模态窗口
            $('.modal').modal({
                backdrop: true,
                keyboard: true,
                focus: true,
                show: false
            });
            
            // 添加模态框关闭事件监听器（正确的Bootstrap 4事件名称）
            $('#imagePreviewModal').on('hidden.bs.modal', function() {
                isDragging = false;
                previewImage.style.cursor = 'grab';
            });
            
            // 初始化Tab切换功能
            // 处理Bootstrap 4和Bootstrap 5的兼容性
            const initTabs = function() {
                // 获取所有Tab按钮
                const tabButtons = document.querySelectorAll('#mainContentTabs .nav-link');
                // 为每个Tab按钮添加点击事件
                tabButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        // 移除所有Tab按钮的active类
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        // 给当前点击的Tab按钮添加active类
                        this.classList.add('active');
                        
                        // 获取目标Tab面板的ID
                        const targetId = this.getAttribute('data-bs-target') || 
                                        this.getAttribute('href') || 
                                        this.getAttribute('data-target');
                        
                        if (targetId) {
                            // 隐藏所有Tab面板
                            document.querySelectorAll('#mainContentTabContent .tab-pane').forEach(pane => {
                                pane.classList.remove('show', 'active');
                                pane.classList.add('fade');
                            });
                            
                            // 显示目标Tab面板
                            const targetPane = document.querySelector(targetId);
                            if (targetPane) {
                                targetPane.classList.add('show', 'active');
                            }
                        }
                    });
                });
                
                console.log('Tab切换功能初始化完成');
            };
            
            // 初始化Tab组件
            initTabs();
            
            console.log('模态窗口初始化完成');
            
            // 给转交订单按钮添加独立的初始化逻辑
            $('#transferOrderBtn').on('click', function() {
                console.log('页面加载完毕后重新绑定的点击事件');
                if($('#transferModal').length) {
                    $('#transferModal').modal('show');
                } else {
                    console.error('找不到转交模态窗口!');
                    alert('系统错误：找不到转交模态窗口，请刷新页面重试');
                }
            });
            
            // 确认转交按钮事件绑定
            $('#confirmTransfer').on('click', function() {
                console.log('点击了确认转交按钮');
                const orderNumber = $('#orderNumber').val();
                const targetUserId = $('#targetUserId').val();
                const note = $('#transferNote').val();
                
                console.log('转交信息:', orderNumber, targetUserId, note);
                
                // 验证选择
                if (!targetUserId) {
                    alert('请选择目标用户');
                    return;
                }
                
                // AJAX提交转交请求
                $.ajax({
                    url: '/admin/transfer_order',
                    method: 'POST',
                    data: {
                        order_number: orderNumber,
                        target_user_id: targetUserId,
                        note: note
                    },
                    success: function(response) {
                        console.log('转交响应:', response);
                        if (response.success) {
                            alert('订单转交成功!');
                            window.location.reload();
                        } else {
                            alert('转交失败: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('转交请求错误:', error);
                        alert('系统错误，请稍后再试');
                    }
                });
            });
            
            // 文件上传功能处理
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('file-input');
            const uploadForm = document.getElementById('upload-form');
            const uploadButton = document.getElementById('upload-button');
            const uploadStatus = document.getElementById('upload-status');
            const processStatus = document.getElementById('process-status');
            
            // 点击上传区域触发文件选择
            dropzone.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 处理文件选择变化
            fileInput.addEventListener('change', function() {
                if (fileInput.files.length > 0) {
                    // 更新上传按钮文本，显示选中的文件数量
                    uploadButton.innerHTML = `<i class="bi bi-upload"></i> 上传 ${fileInput.files.length} 个文件`;
                }
            });
            
            // 处理文件拖拽进入区域
            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.style.border = '2px dashed #007bff';
                dropzone.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
            });
            
            // 处理文件拖拽离开区域
            dropzone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.style.border = '2px dashed #ccc';
                dropzone.style.backgroundColor = '';
            });
            
            // 处理文件拖放
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.style.border = '2px dashed #ccc';
                dropzone.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    // 更新上传按钮文本，显示选中的文件数量
                    uploadButton.innerHTML = `<i class="bi bi-upload"></i> 上传 ${fileInput.files.length} 个文件`;
                }
            });
            
            // 上传按钮点击处理
            uploadButton.addEventListener('click', function() {
                if (fileInput.files.length === 0) {
                    alert('请先选择要上传的文件');
                    return;
                }
                
                // 显示上传状态
                uploadStatus.style.display = 'block';
                uploadButton.disabled = true;
                
                // 提交表单
                uploadForm.submit();
            });
            
            // 材料分类功能
            const fileCategoryMap = {};
            
            // 重置分类按钮点击事件
            $('#reset-classification-btn').on('click', function() {
                if (confirm('确定要重置分类？这将清空所有分类。')) {
                    // 清空所有分类区域
                    $('.category-content').empty();
                    // 重置计数
                    $('.category-count').text('0');
                }
            });
            
            // 保存分类按钮点击事件
            $('#saveClassification').on('click', function() {
                const saveBtn = $(this);
                saveBtn.prop('disabled', true);
                saveBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...');
                
                // 收集分类数据
                const categories = {};
                
                // 使用新的选择器获取分类容器
                console.log('分类容器数量:', document.querySelectorAll('.category-droppable').length);
                console.log('PNG文件数量:', document.querySelectorAll('.png-file-card').length);
                
                // 获取所有分类容器
                document.querySelectorAll('.category-droppable').forEach(container => {
                    const categoryId = container.dataset.categoryId;
                    if (!categoryId) return;
                    
                    // 获取该分类下的所有文件
                    const files = [];
                    container.querySelectorAll('.draggable-item').forEach(item => {
                        const fileUuid = item.dataset.fileUuid;
                        if (fileUuid) {
                            files.push(fileUuid);
                        }
                    });
                    
                    // 将该分类的文件添加到分类数据中
                    categories[categoryId] = files;
                });
                
                if (Object.keys(categories).length === 0) {
                    alert('没有文件需要分类');
                    saveBtn.prop('disabled', false);
                    saveBtn.html('<i class="bi bi-save"></i> 保存分类');
                    return;
                }
                
                console.log('收集到的分类数据(对象格式):', JSON.stringify(categories));
                
                // 将对象格式转换为后端期望的数组格式
                const filesArray = [];
                Object.keys(categories).forEach(categoryId => {
                    categories[categoryId].forEach(fileUuid => {
                        filesArray.push({
                            file_uuid: fileUuid,
                            category: categoryId
                        });
                    });
                });
                
                console.log('将要发送的文件分类数据(数组格式):', JSON.stringify(filesArray));
                
                // 发送AJAX请求保存分类
                $.ajax({
                    url: '/api/files/categorize',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ files: filesArray }),
                    success: function(response) {
                        console.log('分类响应:', response);
                        if (response.success) {
                            alert('文件分类成功');
                            window.location.reload();
                        } else {
                            alert('保存失败: ' + response.message);
                            saveBtn.prop('disabled', false);
                            saveBtn.html('<i class="bi bi-save"></i> 保存分类');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('分类请求错误:', error);
                        console.error('错误详情:', xhr.responseText);
                        alert('系统错误，请稍后再试');
                        saveBtn.prop('disabled', false);
                        saveBtn.html('<i class="bi bi-save"></i> 保存分类');
                    }
                });
            });
            
            // 使PNG文件可拖拽 
            // 使用新的选择器，同时保留旧选择器兼容性
            const pngFiles = document.querySelectorAll('.col-md-3.col-sm-4.col-6.mb-3 .card, .col-md-4.col-sm-4.col-6.mb-3 .card, .png-file-card');
            console.log('找到PNG文件:', pngFiles.length, '个');
            
            pngFiles.forEach(file => {
                // 只处理PNG池中的文件
                const img = file.querySelector('img');
                if (!img) return;
                
                // 让卡片可以拖拽
                file.setAttribute('draggable', 'true');
                
                // 获取文件UUID（从data属性中提取）
                const fileUuid = file.dataset.fileUuid;
                const fileName = img.alt; // 用于显示
                
                if (!fileUuid) {
                    console.warn('找到PNG文件但无法获取UUID，尝试使用文件名作为备选');
                    // 如果没有UUID，使用文件名作为备选（迁移过渡阶段）
                    file.dataset.fileUuid = fileName;
                }
                
                // 添加拖拽事件
                file.addEventListener('dragstart', function(e) {
                    const uuid = this.dataset.fileUuid;
                    const displayName = img.alt;
                    
                    if (uuid) {
                        console.log('开始拖拽文件，UUID:', uuid, '显示名称:', displayName);
                        
                        // 传递包含UUID、显示名称和订单信息的JSON对象
                        const dragData = JSON.stringify({
                            uuid: uuid,
                            display_name: displayName,
                            order_id: '{{ order.id }}',
                            order_number: '{{ order.order_number }}'
                        });
                        
                        e.dataTransfer.setData('application/json', dragData);
                        this.classList.add('dragging');
                        
                        // 记录拖拽开始
                        console.log('拖拽开始:', img);
                    } else {
                        console.error('拖拽失败：找不到文件UUID');
                        e.preventDefault();
                    }
                });
                
                file.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
            });
            
            // 使用事件委托处理拖拽事件，而不是直接绑定到每个容器
            // 获取包含所有分类容器的父元素
            const categoriesContainer = document.getElementById('categoriesContainer');
            if (categoriesContainer) {
                console.log('找到分类容器父元素');
                
                // 为追踪状态，先统计一下容器数量
                const categoryContainers = document.querySelectorAll('.category-droppable');
                console.log('初始分类容器数量:', categoryContainers.length);
                console.log('PNG文件数量:', pngFiles.length);
                
                // 在父容器上绑定dragover事件
                categoriesContainer.addEventListener('dragover', function(e) {
                    // 查找最近的分类容器
                    const dropTarget = e.target.closest('.category-droppable');
                    if (dropTarget) {
                        e.preventDefault(); // 允许放置
                        dropTarget.classList.add('drag-over');
                    }
                });
                
                // 在父容器上绑定dragleave事件
                categoriesContainer.addEventListener('dragleave', function(e) {
                    // 查找最近的分类容器
                    const dropTarget = e.target.closest('.category-droppable');
                    if (dropTarget) {
                        dropTarget.classList.remove('drag-over');
                    }
                });
                
                // 在父容器上绑定drop事件
                categoriesContainer.addEventListener('drop', function(e) {
                    // 查找最近的分类容器
                    const dropTarget = e.target.closest('.category-droppable');
                    if (!dropTarget) return; // 如果不是放置在分类容器中，直接返回
                    
                    e.preventDefault();
                    dropTarget.classList.remove('drag-over');
                    
                    // 记录拖拽释放
                    console.log('拖拽释放:', dropTarget);
                    
                    try {
                        // 获取拖拽的文件数据（包含UUID和显示名称）
                        const dragDataJson = e.dataTransfer.getData('application/json');
                        if (!dragDataJson) {
                            console.error('没有接收到有效的拖拽数据');
                            return;
                        }
                        
                        const dragData = JSON.parse(dragDataJson);
                        const fileUuid = dragData.uuid;
                        const displayName = dragData.display_name || fileUuid;
                        
                        console.log('接收到拖拽文件，UUID:', fileUuid, '显示名称:', displayName);
                        
                        // 获取目标分类容器的分类ID
                        const categoryId = dropTarget.dataset.categoryId;
                        if (!categoryId) {
                            console.error('找不到目标分类ID');
                            return;
                        }
                        
                        // 检查该UUID是否已存在于此分类中
                        const existingItems = dropTarget.querySelectorAll('.draggable-item');
                        for (let item of existingItems) {
                            if (item.dataset.fileUuid === fileUuid) {
                                console.log(`文件 ${displayName} (UUID: ${fileUuid}) 已存在于分类 ${categoryId} 中`);
                                return;
                            }
                        }
                        
                        // 创建一个新的文件项元素
                        const fileItem = document.createElement('div');
                        fileItem.className = 'draggable-item file-item mb-1 p-1 border rounded assigned-file';
                        fileItem.setAttribute('draggable', 'true');
                        fileItem.dataset.fileUuid = fileUuid;
                        fileItem.dataset.categoryId = categoryId;
                        
                        // 设置文件项的HTML内容
                        fileItem.innerHTML = `
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 text-truncate" title="${displayName}">
                                    <small>${displayName}</small>
                                </div>
                                <div class="ms-1">
                                    <a href="javascript:void(0);" class="preview-link btn btn-sm btn-outline-primary py-0 px-1" 
                                       data-toggle="modal" data-target="#imagePreviewModal" 
                                       data-image-url="/preview/${fileUuid}?order_id={{ order.id }}" 
                                       data-image-name="${displayName}"
                                       data-file-uuid="${fileUuid}">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                        `;
                        
                        // 添加拖拽事件到新创建的文件项
                        fileItem.addEventListener('dragstart', function(e) {
                            const dragData = JSON.stringify({
                                uuid: this.dataset.fileUuid,
                                display_name: displayName,
                                category_id: this.dataset.categoryId,
                                order_id: '{{ order.id }}',
                                order_number: '{{ order.order_number }}'
                            });
                            e.dataTransfer.setData('application/json', dragData);
                            this.classList.add('dragging');
                        });
                        
                        fileItem.addEventListener('dragend', function() {
                            this.classList.remove('dragging');
                        });
                        
                        // 添加文件项到分类区域
                        dropTarget.appendChild(fileItem);
                        console.log(`文件 ${displayName} (UUID: ${fileUuid}) 已添加到分类 ${categoryId}`);
                        
                        // 初始化预览功能
                        const previewLink = fileItem.querySelector('.preview-link');
                        if (previewLink) {
                            previewLink.addEventListener('click', function() {
                                const imageUrl = this.getAttribute('data-image-url');
                                const imageName = this.getAttribute('data-image-name');
                                
                                const modal = document.getElementById('imagePreviewModal');
                                const modalImg = modal.querySelector('.modal-img');
                                const modalTitle = modal.querySelector('.modal-title');
                                
                                modalImg.src = imageUrl;
                                modalTitle.textContent = imageName;
                                
                                // 使用Bootstrap 5的方式显示模态窗口
                                const bsModal = new bootstrap.Modal(modal);
                                bsModal.show();
                            });
                        }
                    } catch (error) {
                        console.error('处理拖放操作时出错:', error);
                    }
                });
            } else {
                console.error('找不到分类容器父元素，拖拽功能可能无法正常工作');
            }
            
            // 更新分类计数的辅助函数
            function updateCategoryCount(categoryContainer) {
                if (!categoryContainer) return;
                
                const countBadge = categoryContainer.querySelector('.category-count');
                if (countBadge) {
                    const items = categoryContainer.querySelectorAll('.draggable-item').length;
                    countBadge.textContent = items;
                    countBadge.style.display = items > 0 ? 'inline-block' : 'none';
                }
            }
            
            // 添加调试监控代码
            console.log('分类容器数量:', $('.material-category-container').length);
            console.log('PNG文件数量:', $('.png-file-card').length);
            
            // 监控拖拽事件
            document.addEventListener('dragstart', function(e) {
                console.log('拖拽开始:', e.target);
            }, false);
            
            document.addEventListener('drop', function(e) {
                console.log('拖拽释放:', e.target);
            }, false);
        });

        // 添加样式
        const style = document.createElement('style');
        style.textContent = `
            .dragging {
                opacity: 0.5;
            }
            .drag-over {
                border: 2px dashed #007bff !important;
                background-color: rgba(0, 123, 255, 0.1);
            }
            .material-file-item {
                display: inline-block;
                margin-right: 5px;
            }
            .material-thumbnail {
                position: relative;
            }
            .category-content {
                min-height: 100px;
                padding: 8px;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                transition: all 0.3s ease;
            }
        `;
        document.head.appendChild(style);
        
        // 初始化预览图片功能
        const previewLinks = document.querySelectorAll('.preview-link');
        const previewImage = document.getElementById('previewImage');
        const downloadLink = document.getElementById('downloadLink');
        let currentScale = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;
        
        previewLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const imageUrl = this.dataset.imageUrl;
                const imageName = this.dataset.imageName;
                
                // 预加载图像
                const tempImg = new Image();
                tempImg.onload = function() {
                    previewImage.src = imageUrl;
                    $('#imagePreviewModal').modal('show');
                    downloadLink.href = imageUrl;
                    downloadLink.download = imageName;
                    
                    // 重置缩放和位置
                    currentScale = 1;
                    translateX = translateY = 0;
                    previewImage.style.transform = '';
                };
                tempImg.onerror = function() {
                    alert('图片加载失败，可能是CORS限制或图片不存在');
                };
                tempImg.src = imageUrl;
            });
        });
        
        // 图片拖动功能
        const imageContainer = document.getElementById('imageContainer');
        if (previewImage && imageContainer) {
            previewImage.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                previewImage.style.cursor = 'grabbing';
            });
            
            window.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                previewImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
            });
            
            window.addEventListener('mouseup', function() {
                isDragging = false;
                previewImage.style.cursor = 'grab';
            });
            
            // 缩放功能
            imageContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                currentScale = Math.max(0.5, Math.min(3, currentScale + delta));
                previewImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
            });
            
            // 缩放按钮
            document.getElementById('zoomInButton').addEventListener('click', function() {
                currentScale = Math.min(3, currentScale + 0.2);
                previewImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
            });
            
            document.getElementById('zoomOutButton').addEventListener('click', function() {
                currentScale = Math.max(0.5, currentScale - 0.2);
                previewImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
            });
            
            document.getElementById('resetZoomButton').addEventListener('click', function() {
                currentScale = 1;
                translateX = translateY = 0;
                previewImage.style.transform = '';
            });
            
            // 键盘快捷键
            window.addEventListener('keydown', function(e) {
                if (!$('#imagePreviewModal').hasClass('show')) return;
                
                if (e.key === 'ArrowLeft') {
                    document.getElementById('prevImageButton').click();
                } else if (e.key === 'ArrowRight') {
                    document.getElementById('nextImageButton').click();
                } else if (e.key === 'Escape') {
                    $('#imagePreviewModal').modal('hide');
                }
            });
        }
    });
</script>
{% endblock %}