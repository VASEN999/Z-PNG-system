{% extends "base.html" %}

{% block title %}订单 #{{ order.order_number }} - 文件转换工具{% endblock %}

{% block styles %}
<style>
    /* 状态按钮样式优化 */
    .status-btn {
        min-width: 60px;
        padding: 0.25rem 0.5rem;
        margin-right: 2px;
    }
    
    /* 移动端响应式调整 */
    @media (max-width: 576px) {
        .status-btn {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }
    }
    
    /* 材料分类容器样式 */
    .material-category-container {
        border: 1px solid #ddd;
        border-radius: 5px;
        min-height: 120px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
        transition: all 0.2s ease-in-out;
    }
    
    .category-header {
        background-color: #e9ecef;
        padding: 5px 10px;
        border-bottom: 1px solid #ddd;
        font-weight: 600;
        border-radius: 4px 4px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .category-header .badge {
        background-color: #6c757d;
        color: white;
        font-size: 0.75rem;
        padding: 3px 8px;
    }
    
    .category-content {
        min-height: 80px;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        transition: background-color 0.2s ease;
    }
    
    .category-content:empty::after {
        content: "将文件拖到此处进行分类";
        color: #adb5bd;
        font-style: italic;
        font-size: 0.9rem;
        width: 100%;
        text-align: center;
        margin-top: 10px;
    }
    
    /* 拖拽项目样式 */
    .draggable-item {
        width: 60px;
        height: 60px;
        margin: 2px;
        position: relative;
        cursor: move;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .draggable-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10;
    }
    
    .draggable-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border: 1px solid #ddd;
        border-radius: 3px;
        background-color: white;
    }
    
    .draggable-item.dragging {
        opacity: 0.5;
        transform: scale(1.05);
    }
    
    .draggable-item .remove-item {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: rgba(220, 53, 69, 0.8);
        color: white;
        border-radius: 50%;
        width: 15px;
        height: 15px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        display: none;
        z-index: 20;
    }
    
    .draggable-item:hover .remove-item {
        display: flex;
    }
    
    /* 拖拽时的占位符样式 */
    .drag-placeholder {
        width: 60px;
        height: 60px;
        border: 1px dashed #999;
        background-color: #f0f0f0;
        margin: 2px;
    }
    
    /* 拖拽目标高亮 */
    .category-content.drag-over {
        background-color: rgba(0, 123, 255, 0.1);
        border: 1px dashed #007bff;
    }
    
    /* 分类统计徽章 */
    .category-count {
        font-size: 0.75rem;
        background-color: #6c757d;
    }
    
    /* PNG池中的卡片拖拽样式 */
    .col-md-3.col-sm-4.col-6.mb-3 .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: move;
    }
    
    .col-md-3.col-sm-4.col-6.mb-3 .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .col-md-3.col-sm-4.col-6.mb-3 .card.dragging {
        opacity: 0.5;
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
{% set filter_params = filter_params|default({}) %}
<div class="row">
    <div class="col-12 mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                {% if order.status == order.STATUS_PENDING %}
                <span class="badge bg-warning me-1">待处理</span>
                {% elif order.status == order.STATUS_MATERIAL %}
                <span class="badge bg-danger me-1">补材料</span>
                {% elif order.status == order.STATUS_REVIEWED %}
                <span class="badge bg-success me-1">已审核</span>
                {% endif %}
                订单详情 #{{ order.order_number }}
            </h4>
            <div>
                <a href="{{ url_for('orders.index', **filter_params) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 返回订单列表
                </a>
                <!-- 只有管理员可见的转交按钮 -->
                {% if current_user.is_admin %}
                <button type="button" class="btn btn-sm btn-warning ms-1" id="transferOrderBtn">
                    <i class="bi bi-arrow-right-circle"></i> 转交订单
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- 主内容区域 - 左侧PNG池，右侧订单信息和文件上传 -->
    <div class="col-md-8">
        <!-- 材料分类区域 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">材料分类</h5>
                <div>
                    <div class="btn-group me-2">
                        <button id="view-all-btn" class="btn btn-sm btn-outline-secondary active">
                            <i class="bi bi-grid"></i> 全部视图
                        </button>
                        <button id="view-category-btn" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-collection"></i> 分类视图
                        </button>
                    </div>
                    <button id="save-classification-btn" class="btn btn-sm btn-primary">
                        <i class="bi bi-save"></i> 保存分类
                    </button>
                    <button id="reset-classification-btn" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="material-category-container" data-category="申请表">
                            <div class="category-header">
                                <span>申请表</span>
                                <span class="badge category-count">0</span>
                            </div>
                            <div class="category-content" id="category-application"></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="material-category-container" data-category="证件照">
                            <div class="category-header">
                                <span>证件照</span>
                                <span class="badge category-count">0</span>
                            </div>
                            <div class="category-content" id="category-photo"></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="material-category-container" data-category="户口本">
                            <div class="category-header">
                                <span>户口本</span>
                                <span class="badge category-count">0</span>
                            </div>
                            <div class="category-content" id="category-hukou"></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="material-category-container" data-category="经济材料">
                            <div class="category-header">
                                <span>经济材料</span>
                                <span class="badge category-count">0</span>
                            </div>
                            <div class="category-content" id="category-economic"></div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="material-category-container" data-category="关系证明">
                            <div class="category-header">
                                <span>关系证明</span>
                                <span class="badge category-count">0</span>
                            </div>
                            <div class="category-content" id="category-relationship"></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="material-category-container" data-category="其他材料">
                            <div class="category-header">
                                <span>其他材料</span>
                                <span class="badge category-count">0</span>
                            </div>
                            <div class="category-content" id="category-other"></div>
                        </div>
                    </div>
                </div>
                {% if not converted_files %}
                <div class="alert alert-info mt-3">
                    <p class="mb-0">目前还没有PNG文件可供分类。请上传并处理文件以开始分类。</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- PNG池 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">PNG文件池 ({{ converted_files|length }})</h5>
                {% if converted_files %}
                <div>
                    <a href="{{ url_for('main.download_all', order_id=order.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> 下载全部
                    </a>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if converted_files %}
                <div class="row">
                    {% for file in converted_files %}
                    <div class="col-md-3 col-sm-4 col-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body p-2 text-center">
                                <a href="javascript:void(0);" class="preview-link" data-toggle="modal" data-target="#imagePreviewModal" data-image-url="{{ url_for('main.preview_file', filename=file, order_id=order.id) }}" data-image-name="{{ file }}">
                                    <img src="{{ url_for('main.preview_file', filename=file, order_id=order.id) }}" alt="{{ file }}" class="img-fluid mb-2" style="max-height: 120px; border-radius: 5px;" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'text-center py-3 text-warning\'><i class=\'bi bi-exclamation-triangle\' style=\'font-size: 3rem;\'></i><p class=\'small mt-2\'>文件可能已被移动或删除</p></div>';">
                                </a>
                                <p class="small text-truncate mb-0" title="{{ file }}">{{ file }}</p>
                            </div>
                            <div class="card-footer p-1">
                                <a href="{{ url_for('main.download_file_by_name', filename=file, order_id=order.id) }}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-download"></i> 下载
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    <p class="mb-0">还没有PNG文件。上传文件并点击处理按钮开始转换。</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- 文件上传区域 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">文件上传区域</h5>
                {% if order.files %}
                <div>
                    <form action="{{ url_for('main.process') }}" method="post" id="process-form" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <button type="submit" class="btn btn-sm btn-success">
                            <i class="bi bi-gear"></i> 处理所有文件
                        </button>
                    </form>
                    <form action="{{ url_for('main.clear_png_cache') }}" method="post" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定要清空PNG池吗？这将删除所有转换后的PNG文件，但保留原始上传文件。您可以点击\'处理所有文件\'重新生成PNG文件。');">
                            <i class="bi bi-trash"></i> 清空PNG池
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <form action="{{ url_for('main.upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="order_id" value="{{ order.id }}">
                    <div class="dropzone" id="dropzone" style="border: 2px dashed #ccc; border-radius: 5px; padding: 25px; text-align: center; cursor: pointer;">
                        <i class="bi bi-cloud-upload fs-1"></i>
                        <p>拖放文件至此处上传，或点击选择文件</p>
                        <p class="text-muted small">支持PDF、Word、PPT、图片和ZIP压缩包等多种格式</p>
                        <input type="file" name="files[]" id="file-input" multiple style="display: none;">
                    </div>
                    <div class="d-grid mt-3">
                        <button type="button" id="upload-button" class="btn btn-primary">
                            <i class="bi bi-upload"></i> 上传文件
                        </button>
                    </div>
                </form>
                
                <!-- 上传状态指示器 -->
                <div id="upload-status" class="alert alert-info mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">正在上传...</span>
                        </div>
                        <div>文件上传中，请稍候...</div>
                    </div>
                </div>
                
                <!-- 处理状态指示器 -->
                <div id="process-status" class="alert alert-info mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">正在处理...</span>
                        </div>
                        <div>文件处理中，请稍候...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- 订单基本信息 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">基本信息</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th style="width: 30%">订单号</th>
                        <td>{{ order.order_number }}</td>
                    </tr>
                    <tr>
                        <th>创建时间</th>
                        <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    <tr>
                        <th>更新时间</th>
                        <td>{{ order.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    <tr>
                        <th>创建者</th>
                        <td>
                            {% if order.user %}
                            {{ order.user.username }}
                            {% if order.user.is_admin %}<span class="badge bg-danger">管理员</span>{% endif %}
                            {% else %}
                            <span class="text-muted">未知</span>
                            {% endif %}
                        </td>
                    </tr>
                    <!-- 添加合并信息行 -->
                    {% if order.is_merged %}
                    <tr>
                        <th>合并信息</th>
                        <td>
                            <span class="badge bg-info">合并订单</span>
                            <div class="mt-2">
                                <small class="text-muted">合并自以下订单：</small>
                                <ul class="list-unstyled ms-2 mt-1">
                                    {% if order.merged_from %}
                                        {% for source_number in order.merged_from.split(',') %}
                                            <li>
                                                <small>
                                                    <a href="{{ url_for('orders.view_order', order_number=source_number) }}" class="text-decoration-none">
                                                        <i class="bi bi-box"></i> {{ source_number }}
                                                    </a>
                                                </small>
                                            </li>
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>状态</th>
                        <td>
                            <div class="d-flex flex-column">
                                <div class="mb-2">
                                    {% if order.status == order.STATUS_PENDING %}
                                    <span class="badge bg-warning">{{ order.status_display }}</span>
                                    {% elif order.status == order.STATUS_MATERIAL %}
                                    <span class="badge bg-danger">{{ order.status_display }}</span>
                                    {% elif order.status == order.STATUS_REVIEWED %}
                                    <span class="badge bg-success">{{ order.status_display }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ order.status_display }}</span>
                                    {% endif %}
                                </div>
                                
                                <!-- 状态变更按钮组 -->
                                <div>
                                    <form action="{{ url_for('orders.update_order_status', order_number=order.order_number) }}" method="post" class="status-form w-100">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        {% for key, value in filter_params.items() %}
                                        <input type="hidden" name="_{{ key }}" value="{{ value }}">
                                        {% endfor %}
                                        <div class="d-flex flex-wrap gap-1">
                                            <button type="button" data-status="{{ order.STATUS_PENDING }}" class="btn btn-sm btn-outline-warning status-btn flex-grow-1 {% if order.status == order.STATUS_PENDING %}active{% endif %}">
                                                待处理
                                            </button>
                                            <button type="button" data-status="{{ order.STATUS_MATERIAL }}" class="btn btn-sm btn-outline-danger status-btn flex-grow-1 {% if order.status == order.STATUS_MATERIAL %}active{% endif %}">
                                                补材料
                                            </button>
                                            <button type="button" data-status="{{ order.STATUS_REVIEWED }}" class="btn btn-sm btn-outline-success status-btn flex-grow-1 {% if order.status == order.STATUS_REVIEWED %}active{% endif %}">
                                                已审核
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr id="editNote">
                        <th>备注</th>
                        <td>
                            <div class="d-flex justify-content-between align-items-start">
                                <div id="noteDisplay" class="text-wrap text-break" style="max-width: 300px; max-height: 80px; overflow: auto;" title="{{ order.note }}">{{ order.note or '-' }}</div>
                                <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="editNoteBtn">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                            
                            <div id="noteEditForm" style="display: none;" class="mt-2">
                                <form action="{{ url_for('orders.update_note', order_number=order.order_number) }}" method="post" id="noteForm">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    {% for key, value in filter_params.items() %}
                                    <input type="hidden" name="_{{ key }}" value="{{ value }}">
                                    {% endfor %}
                                    <div class="form-group">
                                        <textarea name="note" class="form-control form-control-sm" rows="3">{{ order.note or '' }}</textarea>
                                    </div>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-primary" id="saveNoteBtn">保存</button>
                                        <button type="button" class="btn btn-sm btn-secondary ms-1" id="cancelEditBtn">取消</button>
                                    </div>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>上传文件</th>
                        <td>{{ order.files|length }} 个</td>
                    </tr>
                    <tr>
                        <th>转换文件</th>
                        <td>{{ order.conversions|length }} 个</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- 上传文件列表 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">数据库文件记录 ({{ order.files|length }})</h5>
            </div>
            <div class="card-body">
                {% if order.files %}
                <div class="list-group">
                    {% for file in order.files %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ file.original_filename }}</h6>
                            <div>
                                <small class="me-2">{{ file.upload_time.strftime('%m-%d %H:%M') }}</small>
                                <a href="{{ url_for('main.delete_upload', filename=file.filename) }}" 
                                   class="btn btn-sm btn-outline-danger" 
                                   title="删除文件" 
                                   onclick="return confirm('确定要删除此文件吗？');">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </div>
                        <p class="mb-1 small text-muted">
                            类型: {{ file.file_type or '未知' }} | 
                            大小: {{ file.file_size|filesizeformat if file.file_size else 'N/A' }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <p class="mb-0">没有上传文件记录</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 图片预览模态框 -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">图片预览</h5>
                <div class="btn-group mx-2">
                    <button type="button" id="prevImageButton" class="btn btn-sm btn-outline-secondary" title="上一张图片">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <button type="button" id="nextImageButton" class="btn btn-sm btn-outline-secondary" title="下一张图片">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <button type="button" id="zoomInButton" class="btn btn-sm btn-outline-secondary" title="放大">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button type="button" id="zoomOutButton" class="btn btn-sm btn-outline-secondary" title="缩小">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button type="button" id="resetZoomButton" class="btn btn-sm btn-outline-secondary" title="重置缩放">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>
                <div class="modal-page-info ms-2 me-auto">
                    <span id="currentImageIndex">1</span>/<span id="totalImages">1</span>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div id="imageContainer" class="text-center" style="overflow: hidden; position: relative; height: 70vh; background-color: #f8f9fa;">
                    <img id="previewImage" src="" alt="预览图片" style="max-height: 100%; max-width: 100%; transition: transform 0.2s; cursor: grab;">
                </div>
            </div>
            <div class="modal-footer">
                <div class="text-muted small me-auto">
                    <i class="bi bi-info-circle"></i> 提示：滚轮可缩放，左键拖动可移动图片，左右箭头键或按钮可切换图片
                </div>
                <a id="downloadLink" href="#" class="btn btn-primary" download>
                    <i class="bi bi-download"></i> 下载图片
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 转交订单模态窗口，直接放在content块内 -->
{% if current_user.is_admin %}
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferModalLabel">转交订单</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <input type="hidden" id="orderNumber" value="{{ order.order_number }}">
                    {% for key, value in filter_params.items() %}
                    <input type="hidden" name="_{{ key }}" value="{{ value }}">
                    {% endfor %}
                    <div class="mb-3">
                        <label for="targetUserId" class="form-label">选择目标用户</label>
                        <select class="form-select" id="targetUserId" name="target_user_id" required>
                            <option value="">请选择...</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}" {% if user.id == order.user_id %}disabled{% endif %}>
                                {{ user.username }} ({{ "管理员" if user.is_admin else "普通用户" }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transferNote" class="form-label">转交备注（可选）</label>
                        <textarea class="form-control" id="transferNote" name="note" rows="3" placeholder="可以添加转交原因或其他说明"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmTransfer">确认转交</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block modals %}
{{ super() }}
<!-- 移除这里的转交订单模态窗口，已移到content块 -->
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化所有模态窗口
        $(document).ready(function() {
            // 使用正确的Bootstrap 4语法初始化模态窗口
            $('.modal').modal({
                backdrop: true,
                keyboard: true,
                focus: true,
                show: false
            });
            
            // 添加模态框关闭事件监听器（正确的Bootstrap 4事件名称）
            $('#imagePreviewModal').on('hidden.bs.modal', function() {
                isDragging = false;
                previewImage.style.cursor = 'grab';
            });
            
            console.log('模态窗口初始化完成');
            
            // 给转交订单按钮添加独立的初始化逻辑
            $('#transferOrderBtn').on('click', function() {
                console.log('页面加载完毕后重新绑定的点击事件');
                if($('#transferModal').length) {
                    $('#transferModal').modal('show');
                } else {
                    console.error('找不到转交模态窗口!');
                    alert('系统错误：找不到转交模态窗口，请刷新页面重试');
                }
            });
            
            // 确认转交按钮事件绑定
            $('#confirmTransfer').on('click', function() {
                console.log('点击了确认转交按钮');
                const orderNumber = $('#orderNumber').val();
                const targetUserId = $('#targetUserId').val();
                const note = $('#transferNote').val();
                
                console.log('转交信息:', orderNumber, targetUserId, note);
                
                // 验证选择
                if (!targetUserId) {
                    alert('请选择目标用户');
                    return;
                }
                
                // 询问确认
                if (!confirm('确定要将此订单转交给选定的用户吗？如果订单当前是活跃状态，转交后将变为非活跃状态。')) {
                    return;
                }
                
                // 发送转交请求
                const formData = new FormData();
                formData.append('target_user_id', targetUserId);
                formData.append('note', note);
                formData.append('csrf_token', '{{ csrf_token() }}');
                
                fetch(`/orders/transfer/${orderNumber}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    console.log('转交响应:', data);
                    // 使用jQuery关闭模态窗口
                    $('#transferModal').modal('hide');
                    
                    if (data.success) {
                        alert(data.message);
                        // 构建URL，添加筛选参数
                        let redirectUrl = '{{ url_for("orders.index") }}';
                        // 如果响应中包含筛选参数，将其添加到URL
                        if (data.filter_params) {
                            const params = new URLSearchParams();
                            for (const [key, value] of Object.entries(data.filter_params)) {
                                params.append(key, value);
                            }
                            if (params.toString()) {
                                redirectUrl += '?' + params.toString();
                            }
                        } else {
                            // 从当前URL获取筛选参数
                            const currentParams = new URLSearchParams(window.location.search);
                            if (currentParams.toString()) {
                                redirectUrl += '?' + currentParams.toString();
                            }
                        }
                        // 刷新页面以显示更新，保留筛选条件
                        window.location.href = redirectUrl;
                    } else {
                        alert('转交失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('请求失败:', error);
                    alert('请求失败，请稍后重试');
                });
            });
        });
        
        // 状态变更功能
        console.log('DOM加载完成，初始化状态变更功能');
        const statusForm = document.querySelector('.status-form');
        const statusButtons = document.querySelectorAll('.status-btn');
        
        // 直接给每个状态按钮添加点击事件
        document.querySelectorAll('.status-btn').forEach(button => {
            button.addEventListener('click', function() {
                const clickedStatus = this.getAttribute('data-status');
                
                if (!statusForm) {
                    alert('状态更新失败：系统错误，未找到提交表单');
                    return;
                }
                
                // 创建表单数据
                const formData = new FormData(statusForm);
                formData.set('status', clickedStatus);
                
                // 显示加载状态
                const originalText = this.textContent.trim();
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                this.disabled = true;
                
                // 禁用所有状态按钮
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                // 发送AJAX请求
                fetch(statusForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('服务器错误: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 更新按钮状态
                        document.querySelectorAll('.status-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // 记录当前状态 - 用于调试
                        console.log('状态变更为:', clickedStatus);
                        
                        // 更新所有状态相关的徽章 - 使用更通用的选择器
                        // 1. 首先更新所有表格中的状态徽章
                        document.querySelectorAll('table .badge').forEach(badge => {
                            // 跳过"活跃"和"管理员"标签
                            if (badge.textContent.trim() === '活跃' || badge.textContent.trim() === '管理员') {
                                return;
                            }
                            
                            // 重置所有可能的徽章类
                            badge.className = 'badge';  // 先重置为基本徽章类
                            
                            // 添加新状态类和文本
                            updateBadgeStatus(badge, clickedStatus);
                        });
                        
                        // 2. 更新页面标题处的状态徽章
                        const titleBadge = document.querySelector('h4 .badge');
                        if (titleBadge) {
                            titleBadge.className = 'badge me-1';
                            updateBadgeStatus(titleBadge, clickedStatus);
                        }
                        
                        // 成功时不显示提醒
                    } else {
                        alert('状态更新失败: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('请求发生错误，请重试');
                })
                .finally(() => {
                    // 恢复按钮文本和状态
                    this.textContent = originalText;
                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.disabled = false;
                    });
                });
            });
        });
        
        // 辅助函数：根据状态更新徽章
        function updateBadgeStatus(badge, status) {
            if (status === 'pending') {
                badge.classList.add('bg-warning');
                badge.textContent = '待处理';
            } else if (status === 'material') {
                badge.classList.add('bg-danger');
                badge.textContent = '补材料';
            } else if (status === 'reviewed') {
                badge.classList.add('bg-success');
                badge.textContent = '已审核';
            }
        }
        
        // 文件上传相关
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const uploadForm = document.getElementById('upload-form');
        const uploadStatus = document.getElementById('upload-status');
        
        // 处理表单
        const processForm = document.getElementById('process-form');
        const processStatus = document.getElementById('process-status');
        
        // 备注编辑功能
        const editNoteBtn = document.getElementById('editNoteBtn');
        const noteDisplay = document.getElementById('noteDisplay');
        const noteEditForm = document.getElementById('noteEditForm');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const noteForm = document.getElementById('noteForm');
        
        console.log('备注编辑组件:', 
            '编辑按钮-', editNoteBtn ? '已找到' : '未找到', 
            '显示区域-', noteDisplay ? '已找到' : '未找到',  
            '编辑表单-', noteEditForm ? '已找到' : '未找到', 
            '保存按钮-', saveNoteBtn ? '已找到' : '未找到',
            '取消按钮-', cancelEditBtn ? '已找到' : '未找到'
        );
        
        // 确保备注编辑按钮正常工作
        if (editNoteBtn) {
            editNoteBtn.addEventListener('click', function() {
                console.log('点击了备注编辑按钮');
                if(noteDisplay) noteDisplay.style.display = 'none';
                if(editNoteBtn) editNoteBtn.style.display = 'none';
                if(noteEditForm) noteEditForm.style.display = 'block';
            });
        }
        
        // 确保保存按钮正常工作
        if (saveNoteBtn && noteForm) {
            saveNoteBtn.addEventListener('click', function() {
                console.log('点击了保存按钮');
                
                // 显示加载状态
                saveNoteBtn.disabled = true;
                saveNoteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
                
                // 获取表单数据
                const formData = new FormData(noteForm);
                
                // 发送AJAX请求
                fetch(noteForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('服务器错误: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('备注更新响应:', data);
                    
                    if (data.success) {
                        // 更新显示区域
                        if (noteDisplay) {
                            noteDisplay.textContent = data.new_note;
                        }
                        
                        // 隐藏编辑表单，显示备注和编辑按钮
                        if(noteDisplay) noteDisplay.style.display = 'block';
                        if(editNoteBtn) editNoteBtn.style.display = 'inline-block';
                        if(noteEditForm) noteEditForm.style.display = 'none';
                    } else {
                        alert('保存备注失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('请求错误:', error);
                    alert('保存备注时发生错误，请重试');
                })
                .finally(() => {
                    // 恢复按钮状态
                    saveNoteBtn.disabled = false;
                    saveNoteBtn.innerHTML = '保存';
                });
            });
        }
        
        // 确保取消按钮正常工作
        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', function() {
                console.log('点击了取消按钮');
                if(noteDisplay) noteDisplay.style.display = 'block';
                if(editNoteBtn) editNoteBtn.style.display = 'inline-block';
                if(noteEditForm) noteEditForm.style.display = 'none';
            });
        }
        
        // 图片预览功能 - 增强版
        const previewLinks = document.querySelectorAll('.preview-link');
        const previewModal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');
        const downloadLink = document.getElementById('downloadLink');
        const modalTitle = document.getElementById('imagePreviewModalLabel');
        const imageContainer = document.getElementById('imageContainer');
        
        // 图片导航按钮
        const prevImageButton = document.getElementById('prevImageButton');
        const nextImageButton = document.getElementById('nextImageButton');
        const currentImageIndexElement = document.getElementById('currentImageIndex');
        const totalImagesElement = document.getElementById('totalImages');
        
        // 图片缩放按钮
        const zoomInButton = document.getElementById('zoomInButton');
        const zoomOutButton = document.getElementById('zoomOutButton');
        const resetZoomButton = document.getElementById('resetZoomButton');
        
        // 全局变量
        let currentScale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let startX, startY;
        let allImages = [];
        let currentImageIndex = 0;
        
        // 收集所有图片URL和名称
        if (previewLinks && previewLinks.length > 0) {
            previewLinks.forEach(link => {
                allImages.push({
                    url: link.getAttribute('data-image-url'),
                    name: link.getAttribute('data-image-name')
                });
            });
            
            // 更新总图片数
            if (totalImagesElement) {
                totalImagesElement.textContent = allImages.length;
            }
            
            // 图片预览点击事件
            previewLinks.forEach((link, index) => {
                link.addEventListener('click', function() {
                    currentImageIndex = index;
                    showCurrentImage();
                });
            });
        }
        
        // 显示当前图片
        function showCurrentImage() {
            if (allImages.length === 0) return;
            
            const currentImage = allImages[currentImageIndex];
            previewImage.src = currentImage.url;
            modalTitle.textContent = `图片预览: ${currentImage.name}`;
            downloadLink.href = currentImage.url;
            downloadLink.setAttribute('download', currentImage.name);
            
            // 更新导航信息
            if (currentImageIndexElement) {
                currentImageIndexElement.textContent = currentImageIndex + 1;
            }
            
            // 重置缩放和位置
            resetImageTransform();
        }
        
        // 图片导航功能
        if (prevImageButton && nextImageButton) {
            // 上一张图片
            prevImageButton.addEventListener('click', function() {
                if (allImages.length === 0) return;
                currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
                showCurrentImage();
            });
            
            // 下一张图片
            nextImageButton.addEventListener('click', function() {
                if (allImages.length === 0) return;
                currentImageIndex = (currentImageIndex + 1) % allImages.length;
                showCurrentImage();
            });
        }
        
        // 键盘导航
        document.addEventListener('keydown', function(e) {
            // 只有当模态框显示时才处理键盘事件
            if (!previewModal.classList.contains('show')) return;
            
            if (e.key === 'ArrowLeft') {
                // 左箭头 - 上一张图片
                if (prevImageButton) prevImageButton.click();
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                // 右箭头 - 下一张图片
                if (nextImageButton) nextImageButton.click();
                e.preventDefault();
            } else if (e.key === 'Escape') {
                // ESC键 - 关闭模态框
                const closeButton = previewModal.querySelector('.close');
                if (closeButton) closeButton.click();
                e.preventDefault();
            }
        });
        
        // 图片缩放功能
        if (zoomInButton && zoomOutButton && resetZoomButton) {
            // 放大
            zoomInButton.addEventListener('click', function() {
                currentScale += 0.2;
                updateImageTransform();
            });
            
            // 缩小
            zoomOutButton.addEventListener('click', function() {
                currentScale = Math.max(0.2, currentScale - 0.2);
                updateImageTransform();
            });
            
            // 重置
            resetZoomButton.addEventListener('click', resetImageTransform);
        }
        
        // 鼠标滚轮缩放
        if (imageContainer) {
            imageContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                
                const delta = e.deltaY || e.detail || e.wheelDelta;
                
                // 计算鼠标指针相对于图片的位置
                const rect = previewImage.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // 缩放前的图片位置和大小
                const oldScale = currentScale;
                
                // 调整缩放比例
                if (delta > 0) {
                    // 向下滚动 - 缩小
                    currentScale = Math.max(0.2, currentScale - 0.1);
                } else {
                    // 向上滚动 - 放大
                    currentScale += 0.1;
                }
                
                // 计算缩放后保持鼠标位置不变所需的平移调整
                if (oldScale !== currentScale) {
                    // 计算缩放因子
                    const factor = currentScale / oldScale;
                    
                    // 计算鼠标位置相对于图片中心的偏移
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const relativeX = mouseX - centerX;
                    const relativeY = mouseY - centerY;
                    
                    // 计算新的平移值，让鼠标下的点保持不变
                    translateX = translateX + relativeX * (1 - factor);
                    translateY = translateY + relativeY * (1 - factor);
                    
                    updateImageTransform();
                }
            }, { passive: false });
        }
        
        // 图片拖拽功能
        if (previewImage && imageContainer) {
            // 开始拖拽
            previewImage.addEventListener('mousedown', function(e) {
                e.preventDefault();
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                previewImage.style.cursor = 'grabbing';
            });
            
            // 拖拽中
            window.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateImageTransform();
            });
            
            // 结束拖拽
            window.addEventListener('mouseup', function() {
                if (!isDragging) return;
                isDragging = false;
                previewImage.style.cursor = 'grab';
            });
        }
        
        // 更新图片变换
        function updateImageTransform() {
            previewImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
        }
        
        // 重置图片变换
        function resetImageTransform() {
            currentScale = 1;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
        }
        
        // 文件上传相关代码
        if (dropzone && fileInput && uploadButton) {
            // 点击上传区域触发文件选择
            dropzone.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 点击上传按钮触发文件选择
            uploadButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件选择后自动提交表单
            fileInput.addEventListener('change', function() {
                if (fileInput.files.length > 0) {
                    // 显示上传中提示
                    uploadStatus.style.display = 'block';
                    uploadButton.disabled = true;
                    uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 上传中...';
                    
                    // 显示已选文件数量
                    const fileCount = fileInput.files.length;
                    if (fileCount > 1) {
                        uploadStatus.querySelector('div:last-child').textContent = `正在上传 ${fileCount} 个文件，请稍候...`;
                    }
                    
                    // 提交表单
                    uploadForm.submit();
                }
            });
            
            // 拖放事件
            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.style.borderColor = '#007bff';
            });
            
            dropzone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.style.borderColor = '#ccc';
            });
            
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.style.borderColor = '#ccc';
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    
                    // 显示上传中提示
                    uploadStatus.style.display = 'block';
                    uploadButton.disabled = true;
                    uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 上传中...';
                    
                    // 显示已选文件数量
                    const fileCount = fileInput.files.length;
                    if (fileCount > 1) {
                        uploadStatus.querySelector('div:last-child').textContent = `正在上传 ${fileCount} 个文件，请稍候...`;
                    }
                    
                    // 提交表单
                    uploadForm.submit();
                }
            });
        }
        
        // 处理表单提交时显示加载状态
        if (processForm) {
            processForm.addEventListener('submit', function() {
                processStatus.style.display = 'block';
            });
        }
        
        // PNG材料分类相关代码
        if (document.getElementById('save-classification-btn')) {
            initMaterialClassification();
        }
        
        function initMaterialClassification() {
            const containers = document.querySelectorAll('.category-content');
            const pngItems = document.querySelectorAll('.col-md-3.col-sm-4.col-6.mb-3 .card');
            const saveButton = document.getElementById('save-classification-btn');
            const resetButton = document.getElementById('reset-classification-btn');
            const viewAllBtn = document.getElementById('view-all-btn');
            const viewCategoryBtn = document.getElementById('view-category-btn');
            const pngPool = document.querySelector('.card.mb-4:nth-child(2)'); // PNG池卡片
            
            // 视图切换功能
            if (viewAllBtn && viewCategoryBtn && pngPool) {
                // 全部视图（默认）
                viewAllBtn.addEventListener('click', function() {
                    viewAllBtn.classList.add('active');
                    viewCategoryBtn.classList.remove('active');
                    // 显示PNG池
                    pngPool.style.display = 'block';
                });
                
                // 分类视图
                viewCategoryBtn.addEventListener('click', function() {
                    viewCategoryBtn.classList.add('active');
                    viewAllBtn.classList.remove('active');
                    // 隐藏PNG池，只显示分类区域
                    pngPool.style.display = 'none';
                });
            }
            
            // 更新分类计数函数
            function updateCategoryCounts() {
                document.querySelectorAll('.material-category-container').forEach(container => {
                    const count = container.querySelector('.category-content').children.length;
                    const badge = container.querySelector('.category-count');
                    if (badge) {
                        badge.textContent = count;
                        // 视觉反馈：如果有项目，徽章变为蓝色
                        badge.style.backgroundColor = count > 0 ? '#007bff' : '#6c757d';
                    }
                });
            }
            
            // 初始更新计数
            updateCategoryCounts();
            
            // 使PNG池中的图片可拖拽
            if (pngItems && pngItems.length > 0) {
                pngItems.forEach(card => {
                    // 让卡片可拖拽
                    card.setAttribute('draggable', 'true');
                    
                    // 获取图片信息
                    const imgLink = card.querySelector('.preview-link');
                    if (!imgLink) return;
                    
                    const imgUrl = imgLink.getAttribute('data-image-url');
                    const imgName = imgLink.getAttribute('data-image-name');
                    
                    // 添加拖拽事件
                    card.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('text/plain', imgName);
                        e.dataTransfer.setData('image-url', imgUrl);
                        this.classList.add('dragging');
                    });
                    
                    card.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                    });
                });
            }
            
            // 处理拖拽目标区域事件
            containers.forEach(container => {
                container.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                container.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                container.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    const filename = e.dataTransfer.getData('text/plain');
                    const imageUrl = e.dataTransfer.getData('image-url');
                    
                    // 检查该容器是否已存在同名文件
                    const existingItem = this.querySelector(`.draggable-item[data-filename="${filename}"]`);
                    if (existingItem) {
                        // 如果已存在，不再添加
                        return;
                    }
                    
                    // 创建新的拖拽项
                    const dragItem = document.createElement('div');
                    dragItem.className = 'draggable-item';
                    dragItem.setAttribute('data-filename', filename);
                    dragItem.setAttribute('draggable', 'true');
                    
                    // 创建图片元素
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = filename;
                    dragItem.appendChild(img);
                    
                    // 添加删除按钮
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-item';
                    removeBtn.innerHTML = 'x';
                    removeBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        dragItem.parentNode.removeChild(dragItem);
                        // 更新分类计数
                        updateCategoryCounts();
                    });
                    dragItem.appendChild(removeBtn);
                    
                    // 添加拖拽事件
                    dragItem.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('text/plain', filename);
                        this.classList.add('dragging');
                    });
                    
                    dragItem.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                    });
                    
                    // 将元素添加到容器
                    this.appendChild(dragItem);
                    
                    // 更新分类计数
                    updateCategoryCounts();
                });
            });
            
            // 保存分类按钮点击事件
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    // 检查是否有图片可以分类
                    const hasImages = document.querySelectorAll('.draggable-item').length > 0;
                    if (!hasImages) {
                        alert('没有可分类的图片。请将PNG池中的图片拖动到对应的分类框中。');
                        return;
                    }
                    
                    // 收集分类数据
                    const categorizedFiles = {};
                    
                    document.querySelectorAll('.material-category-container').forEach(container => {
                        const category = container.getAttribute('data-category');
                        const files = [];
                        
                        container.querySelectorAll('.draggable-item').forEach(item => {
                            files.push({
                                filename: item.getAttribute('data-filename')
                            });
                        });
                        
                        if (files.length > 0) {
                            categorizedFiles[category] = files;
                        }
                    });
                    
                    // 显示保存中状态
                    const originalText = saveButton.innerHTML;
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
                    
                    // 发送到后端
                    fetch('{{ url_for("main.classify_materials") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({
                            categorized_files: categorizedFiles
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 显示成功消息
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show';
                            alertDiv.innerHTML = `
                                <strong>成功!</strong> ${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            `;
                            document.querySelector('.card-body').prepend(alertDiv);
                            
                            // 延时刷新页面
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            alert('保存失败: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('请求发生错误，请重试');
                    })
                    .finally(() => {
                        // 恢复按钮状态
                        saveButton.disabled = false;
                        saveButton.innerHTML = originalText;
                    });
                });
            }
            
            // 重置分类按钮点击事件
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    const hasItems = document.querySelectorAll('.draggable-item').length > 0;
                    if (!hasItems) {
                        alert('没有可重置的分类项目。');
                        return;
                    }
                    
                    if (confirm('确定要重置所有分类吗？这将清空所有分类框。')) {
                        // 删除所有拖拽项
                        document.querySelectorAll('.draggable-item').forEach(item => {
                            item.parentNode.removeChild(item);
                        });
                        // 更新分类计数
                        updateCategoryCounts();
                    }
                });
            }
        }
    });
</script>
{% endblock %} 