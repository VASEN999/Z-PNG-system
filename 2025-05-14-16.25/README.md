# 文件转PNG工具

这是一个基于Flask的Web应用程序，提供文件上传、处理和转换功能。主要功能是将各种格式的文件（PDF、Word、PPT、图片等）转换为PNG格式，并提供文件管理和订单系统。

## 核心功能

- 文件上传：支持PDF、Word、PowerPoint、图片和ZIP压缩包等多种格式
- 文件转换：将上传的文件转换为PNG格式
- 批量处理：支持批量上传和处理多个文件
- 压缩包处理：自动解压ZIP文件并处理其中的内容（支持嵌套ZIP）
- 文件预览：提供转换后PNG文件的预览功能
- 文件下载：支持单独下载或批量下载转换后的文件
- 订单系统：文件处理以订单为单位进行管理
- 回滚功能：可以回滚到历史订单，恢复之前的文件和PNG
- 管理员控制：提供管理员控制面板，管理订单和系统设置
- 哈希映射系统：通过文件哈希值建立订单号→压缩包→PNG的间接映射关系

## 技术栈

- 后端：Flask、SQLAlchemy、Python图像处理库
- 前端：Bootstrap 5、JavaScript
- 数据库：SQLite

## 安装与运行

### 环境要求

- Python 3.7+
- 依赖库：见`requirements.txt`

### 安装步骤

1. 克隆仓库或下载源代码

2. 创建虚拟环境（可选但推荐）
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```

3. 安装依赖
   ```bash
   pip install -r requirements.txt
   ```

4. 运行应用
   ```bash
   python run.py
   ```

5. 访问应用
   在浏览器中打开 http://127.0.0.1:5000

## 使用说明

### 基本使用流程

1. 打开首页，将文件拖放到上传区域或点击上传按钮选择文件
2. 文件上传完成后，点击"处理所有文件"按钮开始转换
3. 转换完成后，可以在右侧区域预览和下载转换后的PNG文件

### 订单系统

- 每次上传和处理文件时会自动创建或使用当前订单
- 可以通过右上角的"订单管理"查看所有历史订单
- 可以回滚到任何历史订单，恢复之前的文件状态

### 管理员功能

- 点击右上角"管理员登录"进入管理面板（默认账号：admin，密码：admin123）
- 管理员可以查看统计数据、管理订单、修改系统设置等

## 项目结构

```
|- app/                    # 应用主目录
|- templates/              # HTML模板
|- migrations/             # 数据库迁移
|- instance/               # 实例配置
|- flask_session/          # 会话存储
|- db_manage.py            # 数据库管理工具
|- models.py               # 数据库模型
|- config.py               # 配置文件
|- run.py                  # 应用入口
|- start.sh                # 启动脚本
|- requirements_simple.txt # 项目依赖
```

## 使用说明

1. 安装依赖: `pip install -r requirements_simple.txt`
2. 启动应用: `./start.sh`
3. 数据库管理:
   - 重置数据库: `python db_manage.py reset`
   - 创建表: `python db_manage.py create_tables`
   - 重置管理员: `python db_manage.py reset_admin`## 注意事项

- 本应用默认使用SQLite数据库，无需额外配置
- 首次运行时会自动创建数据库和默认管理员账户
- 上传文件大小默认限制为50MB
- 支持的文件格式：PDF、DOCX/DOC、PPTX/PPT、JPG/JPEG/PNG/BMP、ZIP
- ZIP文件内的嵌套层级支持最多3层

## 哈希值映射系统

系统使用SHA-256哈希算法为每个文件创建唯一标识，确保即使原始文件丢失也能找到对应的转换文件：

### 工作原理
- **直接映射**: 订单号 → 压缩包 → PNG文件
- **间接映射**: 订单号 → 压缩包哈希值 → PNG文件

当原始压缩包丢失时，系统仍能通过哈希值找到PNG文件：
1. 接收请求访问特定订单中的PNG文件
2. 在数据库中查找该订单中的文件记录
3. 使用源文件哈希值作为索引查找相同内容的文件
4. 即使原始文件不存在，也能通过哈希值关联找到对应的PNG

### 主要优势
- 防止原始文件丢失导致PNG无法访问
- 节省存储空间，相同内容的文件只需保存一份
- 提高文件恢复的成功率和速度
- 跨订单文件自动关联，数据更具连贯性

## 文件恢复系统

系统采用多层次文件存档和恢复机制，确保文件不会丢失：

### 存档机制
- 每次创建新订单时，自动将当前活跃订单的所有文件存档
- 存档按订单号组织，保存在`app/archive`目录下
- 支持上传文件和转换后文件的双重存档

### 文件恢复流程
文件访问时遵循以下顺序查找：
1. 当前工作目录（uploads/converted）
2. 原始文件路径（数据库记录）
3. 通过源文件哈希值查找同内容文件
4. 当前订单的存档目录
5. 全局存档目录
6. 其他订单的存档目录

### 故障排除

#### 文件无法预览或下载
如果回滚后出现文件不可见或下载404错误：

1. 运行存档重建工具
   ```bash
   python rebuild_archives.py
   ```
2. 检查文件系统权限，确保程序可读写存档目录
3. 查看日志文件，了解具体错误信息

#### 手动恢复文件
如需手动恢复特定订单的文件：

1. 确认订单号，例如 `20250507-43749f48`
2. 在存档目录中查找对应文件：
   ```bash
   app/archive/converted/20250507-43749f48/
   ```
3. 将文件复制到对应工作目录：
   ```bash
   app/converted/
   ```

#### 更新文件哈希值
如果文件哈希值丢失或需要重新计算：

1. 运行数据库更新和哈希值重建脚本：
   ```bash
   python update_db.py
   python rebuild_archives.py
   ```

## 开发者指南

### 添加新功能
1. 遵循蓝图模式，在对应目录创建新功能
2. 更新数据模型时执行数据库迁移
3. 确保新功能支持文件存档和恢复机制

### 数据安全
为保证文件完整性，请定期备份：
1. 数据库文件（app.db）
2. 存档目录（app/archive）

## 故障排除
如果遇到"BuildError"错误，检查URL端点是否正确，尤其在修改路由后。 