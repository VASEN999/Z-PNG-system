以下是一个**清晰、标准化的文件生命周期流程**，用于指导你未来维护代码和扩展功能。全流程描述分为四大阶段：上传、转换、存储与索引、归档。

---

### 🟢 阶段一：用户上传文件（入口）

1. **前端触发上传请求**：用户通过浏览器 UI 拖拽或选择文件后，调用 Flask 主服务的 `/upload` 接口，发起 `POST` 请求。
2. **Flask 接收上传数据**：后端通过 `werkzeug.FileStorage` 接收原始文件，并做基础校验（如大小限制、文件类型检查）。
3. **保存临时文件副本**：原始文件被写入 `uploads/{订单号}/{原始文件名}`。
4. **生成订单记录**（如无则创建）：系统为此次上传打一个订单号（如 `20250606-efbe002c`），关联上传的所有文件。
5. **生成文件元信息（数据库）**：如 `filename`、`hash`（SHA-256）、`上传时间`、`归属订单`，写入 `files` 表。
6. **发送任务到转换服务**：调用 `convert-svc` 接口（可能是 HTTP 或 gRPC），传入文件路径或内容，要求生成 PNG 文件。

---

### 🔵 阶段二：文件转换处理（convert-svc）

1. **接收转换请求**：convert-svc 监听端口接收 `/api/convert` 请求，参数包含文件路径、类型、输出目录等。
2. **解析文件类型**：判断是 PDF、Word、PPT 还是图片/压缩包，自动派发给对应的处理模块（如 `pdf2png()`, `docx2png()`）。
3. **执行转换任务**：将每页或每张图转为 PNG，命名为 `{原文件名}_{页码}.png`，保存到 `converted/{订单号}/`。
4. **生成转换结果清单**：返回一个 JSON，包含转换后的 PNG 文件名、页数、状态信息等。
5. **发送转换完成通知（可选）**：调用 Flask 主服务的回调接口 `/notify_conversion_complete` 或返回成功响应，携带 JSON 结果。

---

### 🟡 阶段三：存储、索引与预览（主服务）

1. **记录转换结果入库**：主服务根据 convert-svc 返回结果，更新数据库中对应文件的转换状态、PNG 文件列表等字段。
2. **建立哈希索引关系**：以文件 SHA-256 哈希为 key，在 `hash_map` 表中建立如下逻辑：

   ```
   订单号 → 原始文件 → 哈希 → 对应PNG文件路径列表
   ```
3. **更新用户界面**：前端查询 `/order/{订单号}` 时会拿到当前订单下所有文件的转换结果并展示缩略图、下载链接等。

---

### 🔴 阶段四：文件归档与回滚（archive-svc）

1. **触发归档操作**：每次转换完成后或用户点击“归档”按钮时，主服务通过调用 `archive-svc` 的 `/api/archive` 接口，传入订单号。
2. **archive-svc 拉取文件清单**：根据订单号，扫描该订单下所有文件与 PNG，复制到 `app/archive/converted/{订单号}/`。
3. **双重归档**（可选）：同时归档：

   * 原始上传文件
   * 转换后的 PNG 文件
4. **哈希反向追踪建立**：归档服务也可选做：根据哈希生成一个反向索引清单（供以后查找 PNG 即便源文件不存在时用）。
5. **归档完成通知**：返回状态或调用主服务接口 `/notify_archive_done`，更新数据库中订单归档状态字段。

---

### 🔁 文件回滚/恢复逻辑（归档→激活）

当用户在订单管理界面点击“回滚至历史订单”时：

1. 主服务查找该订单对应归档路径；
2. 检查原始上传文件是否还在 `uploads`，如无则从 `archive/converted/订单号/` 复制回；
3. 检查 PNG 文件是否在 `converted/`，如无则尝试从归档目录中恢复；
4. 若再无法恢复，尝试通过哈希查找相同内容文件的PNG副本并关联；
5. 所有成功恢复的文件路径重新建立索引，数据库状态更新为“已恢复”。

---

### 🔧 文件异常排查流程（用户打不开、404）

1. 首先查当前路径 `converted/` 是否存在文件；
2. 如无，查 `uploads/` 是否存在原文件；
3. 如仍无，查数据库中的哈希值，找是否有其他相同哈希文件的PNG副本；
4. 如无结果，查归档目录；
5. 若全都找不到，记录日志、提示“转换文件可能已丢失”。

--
